<!DOCTYPE html>
<html>
  <head>
    <title>Book an appointment</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <h1>Book an appointment</h1>
    <form method="POST" action="/appointments/">
      <label for="doctor_id">Doctor</label>
      <select name="doctor_id" id="doctor_id" required>
        <% doctors.forEach(function(doc){ %>
          <option value="<%= doc.doctor_id %>"><%= doc.surname %> <%= doc.name %> - <%= doc.specialty %></option>
        <% }); %>
      </select>

      <label for="time_slot_id">Time slot</label>
      <select name="time_slot_id" id="time_slot_id" required></select>

      <label for="reason">Reason (optional)</label>
      <textarea name="reason" id="reason" rows="3"></textarea>

      <button type="submit">Book</button>

      <script>
        (function(){
          function formatTs(ts){
            try { return new Date(ts).toLocaleString(); } catch(e) { return ts; }
          }
          function loadSlots(doctorId){
            var select = document.getElementById('time_slot_id');
            select.innerHTML = '';
            if(!doctorId) return;
            fetch('/appointments/slots?doctor_id=' + encodeURIComponent(doctorId), { credentials: 'same-origin' })
              .then(function(r){ return r.json(); })
              .then(function(data){
                (data.slots || []).forEach(function(slot){
                  var opt = document.createElement('option');
                  opt.value = slot.id;
                  opt.textContent = formatTs(slot.start_ts) + ' - ' + formatTs(slot.end_ts);
                  select.appendChild(opt);
                });
                if (select.options.length === 0) {
                  var opt = document.createElement('option');
                  opt.value = '';
                  opt.textContent = 'No available slots';
                  select.appendChild(opt);
                }
              })
              .catch(function(){
                var opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Error loading slots';
                select.appendChild(opt);
              });
          }
          var doctorSelect = document.getElementById('doctor_id');
          doctorSelect.addEventListener('change', function(){ loadSlots(this.value); });
          // initial load
          if (doctorSelect.value) { loadSlots(doctorSelect.value); }
        })();
      </script>
    </form>

    <p><a href="/">Back</a></p>
  </body>
  </html>


